{% load portfolio_extras %}
<!doctype html>
<html lang="ru">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Портфолио — monocode</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
        <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
        <style>
            html, body { height: 100%; margin: 0; }
            html { scroll-behavior: smooth; scrollbar-color: #d1d5db #ffffff; scrollbar-width: thin; }
            html::-webkit-scrollbar { width: 8px; height: 8px; }
            html::-webkit-scrollbar-track { background: #ffffff; }
            html::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 8px; }
            body { background: #ffffff; color: #6b7280; font: 14px/1.6 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; overflow-y: auto; padding-top: 56px;
                cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 22 22'><defs><filter id='s' x='-50%' y='-50%' width='200%' height='200%'><feDropShadow dx='0' dy='0' stdDeviation='0.3' flood-color='%239ca3af' flood-opacity='0.35'/></filter></defs><g filter='url(%23s)'><path d='M11 1.8 L20.2 11 L11 20.2 L1.8 11 Z' fill='%23ffffff' fill-opacity='0.7' stroke='%239ca3af' stroke-width='1.1'/><circle cx='11' cy='11' r='1.1' fill='%239ca3af'/></g></svg>") 11 11, auto; }
            a, button, .btn { cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 22 22'><path d='M11 1.8 L20.2 11 L11 20.2 L1.8 11 Z' fill='%23f9fafb' stroke='%23111827' stroke-width='1.5'/><circle cx='11' cy='11' r='1.2' fill='%23111827'/></svg>") 11 11, pointer; }
            header.site { position: fixed; top: 0; left: 0; right: 0; height: 56px; display: flex; align-items: center; z-index: 2; background: rgba(255,255,255,0.72); border-bottom: 1px solid #f3f4f6; backdrop-filter: saturate(160%) blur(6px); transition: background 200ms ease, backdrop-filter 200ms ease, box-shadow 200ms ease; }
            header.site.scrolled { background: rgba(255,255,255,0.9); backdrop-filter: saturate(180%) blur(12px); box-shadow: 0 4px 12px rgba(17,24,39,0.04); }
            header .wrap { width: 100%; max-width: 1100px; margin: 0 auto; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; }
            .brand { color: #111827; font-weight: 600; letter-spacing: -0.01em; }
            nav a { color: #6b7280; text-decoration: none; margin-left: 16px; font-size: 13px; }
            nav a:hover { color: #111827; }
            .container { width: 100%; max-width: 1100px; margin: 0 auto; padding: 0 16px; }
            .section { padding: 48px 0; }
            .section + .section { border-top: 1px solid #f3f4f6; }
            h1 { margin: 0 0 12px; font-weight: 600; font-size: 40px; line-height: 1.15; color: #111827; letter-spacing: -0.01em; text-align: center; }
            .sub { margin: 0 0 32px; color: #4b5563; text-align: center; }
            .projects-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; }
            .project-card { border: 1px solid #e5e7eb; border-radius: 12px; background: #ffffff; overflow: hidden; transition: transform 200ms ease, box-shadow 200ms ease; }
            .project-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(17,24,39,0.08); }
            .project-image { width: 100%; height: 200px; background: #f9fafb; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-size: 14px; }
            .project-content { padding: 20px; }
            .project-title { margin: 0 0 8px; font-size: 18px; color: #111827; font-weight: 600; }
            .project-description { margin: 0 0 12px; font-size: 14px; color: #6b7280; line-height: 1.5; }
            .project-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 16px; }
            .tag { display: inline-block; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 999px; font-size: 12px; color: #374151; background: #f9fafb; }
            .project-links { display: flex; gap: 8px; }
            .project-link { display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; color: #111827; text-decoration: none; font-size: 13px; background: #ffffff; transition: background 200ms ease; }
            .project-link:hover { background: #f9fafb; }
            .project-link i { font-size: 14px; }
            .cta-section { text-align: center; padding: 48px 0; }
            .btn { display: inline-block; padding: 12px 20px; border: 1px solid #e5e7eb; border-radius: 10px; color: #111827; text-decoration: none; background: #ffffff; font-weight: 500; transition: background 200ms ease; }
            .btn:hover { background: #f9fafb; }
            footer { background: #ffffff; text-align: center; padding: 12px 16px; }
            footer a { color: inherit; text-decoration: none; margin: 0 8px; opacity: 0.85; }
            footer a:hover { opacity: 1; text-decoration: underline; }
            #fx { position:absolute; top:0; left:0; pointer-events:none; z-index:0; }
            @media (max-width: 768px) { 
                .projects-grid { grid-template-columns: 1fr; }
                h1 { font-size: 32px; }
            }
        </style>
    </head>
    <body>
        <canvas id="fx" width="0" height="0"></canvas>
        <header class="site">
            <div class="wrap">
                <div class="brand" onclick="window.location.href='{% url 'main:home' %}'" style="cursor: pointer;">monocode</div>
                <nav>
                    <a href="{% url 'main:home' %}">Главная</a>
                    <a href="{% url 'main:about' %}">О студии</a>
                    <a href="{% url 'main:contact' %}">Контакты</a>
                </nav>
            </div>
        </header>

        <main class="section">
            <div class="container">
                <h1>Портфолио</h1>
                <p class="sub">Проекты, которые мы создали для наших клиентов</p>
                
                <div class="projects-grid">
                    {% for project in projects %}
                    <div class="project-card" onclick="window.location.href='{% url 'portfolio:portfolio_detail' project.slug %}'" style="cursor: pointer;">
                        <div class="project-image">
                            {% if project.cover_image %}
                                <img src="{{ project.cover_image.url }}" alt="{{ project.title }}" style="width: 100%; height: 100%; object-fit: cover;">
                            {% else %}
                                <i class='bx bx-image' style="font-size: 32px;"></i>
                            {% endif %}
                        </div>
                        <div class="project-content">
                            <h3 class="project-title">{{ project.title }}</h3>
                            <p class="project-description">{{ project.description|truncatewords:20 }}</p>
                            <div class="project-tags">
                                {% for tech in project.technologies|split:"," %}
                                    <span class="tag">{{ tech|strip }}</span>
                                {% endfor %}
                            </div>
                            <div class="project-links">
                                {% if project.project_url %}
                                <a href="{{ project.project_url }}" class="project-link" target="_blank" onclick="event.stopPropagation();">
                                    <i class='bx bx-link-external'></i>
                                    Сайт
                                </a>
                                {% endif %}
                                <a href="{% url 'portfolio:portfolio_detail' project.slug %}" class="project-link" onclick="event.stopPropagation();">
                                    <i class='bx bx-show'></i>
                                    Кейс
                                </a>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="project-card" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <div class="project-content">
                            <h3 class="project-title">Портфолио пусто</h3>
                            <p class="project-description">Проекты будут добавлены в ближайшее время.</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </main>

        <section class="cta-section">
            <div class="container">
                <h2 style="margin: 0 0 12px; font-size: 24px; color: #111827;">Готовы обсудить ваш проект?</h2>
                <p style="margin: 0 0 24px; color: #6b7280;">Расскажите о задаче — предложим решение и сроки</p>
                <a href="{% url 'main:contact' %}" class="btn">Связаться с нами</a>
            </div>
        </section>

        <script>
        (function(){
            const header=document.querySelector('header.site');
            const onScroll=()=>{ if(window.scrollY>8) header.classList.add('scrolled'); else header.classList.remove('scrolled'); };
            onScroll();
            window.addEventListener('scroll', onScroll, {passive:true});

            // click background effect: pixel-aligned grid burst (anchored to page)
            const canvas = document.getElementById('fx');
            const ctx = canvas.getContext('2d');
            const DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
            const resize = () => {
                const doc = document.documentElement;
                const w = Math.max(doc.scrollWidth, innerWidth);
                const h = Math.max(doc.scrollHeight, innerHeight);
                canvas.width = Math.floor(w * DPR);
                canvas.height = Math.floor(h * DPR);
                canvas.style.width = w + 'px';
                canvas.style.height = h + 'px';
                ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
            };
            resize();
            window.addEventListener('resize', resize);

            const bursts = [];
            const GRID = 8;
            function snap(v) { return Math.round(v / GRID) * GRID; }
            function addBurst(x, y) {
                const start = performance.now();
                const cells = [];
                const steps = 60 + Math.floor(Math.random() * 40);
                let gx = snap(x), gy = snap(y);
                const dirs = [ [GRID,0], [-GRID,0], [0,GRID], [0,-GRID] ];
                const used = new Set();
                function key(cx, cy) { return cx+','+cy; }
                used.add(key(gx,gy));
                cells.push({ x: gx, y: gy, d: 0 });
                for (let i=0;i<steps;i++) {
                    const [dx,dy] = dirs[(Math.random()*dirs.length)|0];
                    gx += dx; gy += dy;
                    const k = key(gx,gy);
                    if (used.has(k)) continue;
                    used.add(k);
                    cells.push({ x: gx, y: gy, d: i+1 });
                }
                cells.forEach(c => { c.delay = 30 + Math.random()*300 + c.d*6; c.size = 2; c.alpha = 0; });
                bursts.push({ start, cells, duration: 1200 });
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const now = performance.now();
                for (let b = bursts.length - 1; b >= 0; b--) {
                    const burst = bursts[b];
                    const elapsed = now - burst.start;
                    burst.cells.forEach(c => {
                        const t = Math.max(0, Math.min(1, (elapsed - c.delay) / 600));
                        if (t <= 0) return;
                        const ease = t * (2 - t);
                        const sz = 2 + ease * 6;
                        const a = 0.35 * (1 - t);
                        ctx.fillStyle = `rgba(0,0,0,${a})`;
                        const cx = c.x - sz/2, cy = c.y - sz/2;
                        ctx.fillRect(Math.round(cx)+0.5, Math.round(cy)+0.5, Math.round(sz), Math.round(sz));
                    });
                    if (elapsed > burst.duration + 800) bursts.splice(b, 1);
                }
                requestAnimationFrame(draw);
            }
            draw();

            document.addEventListener('click', (e) => {
                const target = e.target;
                if (target.closest('a, button, .btn, .card, .partner, footer')) return;
                const x = window.scrollX + e.clientX;
                const y = window.scrollY + e.clientY;
                addBurst(x, y);
            });
        })();
        </script>

        <footer>
            <a href="{% url 'main:home' %}" rel="noopener">Главная</a>
            <a href="{% url 'main:about' %}" rel="noopener">О студии</a>
            <a href="{% url 'main:contact' %}" rel="noopener">Контакты</a>
            </br>
            <p style="margin-top: 7px;">Сделано с <span class="heart" aria-label="с любовью"><i class='bx bxs-heart' style="color:red;"></i></span> студией monocode • © <span id="y"></span></p>
            <script>document.getElementById('y').textContent = new Date().getFullYear();</script>
        </footer>
    </body>
</html>
